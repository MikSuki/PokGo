<html>

<head>
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        canvas {
            position: absolute;
            top: 0;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/three.js/110/three.js'></script>
    <script src="js/lib/GLTFLoader.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
    <canvas id='cns'></canvas>
    <canvas id='cns2'></canvas>
    <script>

        const canvas = $('#cns')[0]
        const ctx = canvas.getContext('2d')

        canvas.width = window.innerWidth
        canvas.height = window.innerHeight

        const img = new Image()
        img.onload = function () {
            ctx.drawImage(img, window.innerWidth / 2 - img.width / 2, 0)
        }
        img.src = 'https://i.imgur.com/2u64LR5.png'


        const ball = {
            pos: {
                x: window.innerWidth / 2,
                y: window.innerHeight * 0.85
            },
            size: { w: 75, h: 75 },
            velocity: { x: 0, y: 10 },
            img: new Image(),
            draw: function (ctx) {
                ctx.drawImage(
                    this.img,
                    this.pos.x - this.size.w / 2,
                    this.pos.y - this.size.h / 2,
                    this.size.w,
                    this.size.h
                )
            }
        }
        const gravity = 9.8

        ball.img.onload = function () {
            ball.draw(ctx)
        }
        ball.img.src = 'https://i.imgur.com/yZCHxYY.png'


    </script>

    <script>
        var world, sphereBody, timeStep, s_mass = 1;
        var scene, camera, renderer, pokeball;
        var isclick = false, get_mouse_move = false;
        var mouse_cur = new THREE.Vector2();
        var mouse_last = new THREE.Vector2();
        var v = { x: 0, y: 0 }
        const canvas2 = $("#cns2")

        var throwb = false;

        const MODEL_PATH = 'static/model/pokeball.glb'

        initCannon()
        initThree()

        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            console.log('phone')
            canvas2.on('touchstart', function (e) {
                e.preventDefault();
                onCursorDown(e.touches[0].clientX, e.touches[0].clientY)
            })
            canvas2.on('touchmove', function (e) {
                e.preventDefault();
                onCursorMove(e.touches[0].clientX, e.touches[0].clientY)
            })
            canvas2.on('touchend', function (e) {
                e.preventDefault();
                console.log('end')
                onCursorUp()
            })
        }
        else {
            console.log('PC')
            canvas2.on('mousedown', function (e) {
                e.preventDefault();
                onCursorDown(e.clientX, e.clientY)
            })
            canvas2.on('mousemove', function (e) {
                e.preventDefault();
                onCursorMove(e.clientX, e.clientY)
            })
            canvas2.on('mouseup', function (e) {
                e.preventDefault();
                onCursorUp()
            })
            canvas2.on('mouseout', function (e) {
                e.preventDefault();
                onCursorUp()
            })
        }


        function initCannon() {
            world = new CANNON.World();
            world.quatNormalizeSkip = 0;
            world.quatNormalizeFast = false;

            world.gravity.set(0, -10, 0);
            world.broadphase = new CANNON.NaiveBroadphase();


            // Create a sphere
            var radius = 1; // m
            sphereBody = new CANNON.Body({
                mass: s_mass, // kg
                position: new CANNON.Vec3(0, -2, 0), // m
                shape: new CANNON.Sphere(radius)
            });
            world.addBody(sphereBody);


            var groundShape = new CANNON.Plane();
            var groundBody = new CANNON.Body({ mass: 0 });
            groundBody.addShape(groundShape);
            groundBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), -Math.PI / 2);
            groundBody.position.y = -3
            world.addBody(groundBody);


            timeStep = 1.0 / 60.0; // seconds
        }

        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({
                canvas: canvas2[0],
                alpha: true,
            });

            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            camera.position.z = 5;
            var hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444);
            hemiLight.position.set(0, 0, 0);
            scene.add(hemiLight);

            // drawPokemon()
            drawPokeball()

            function drawPokemon() {
                var loader = new THREE.TextureLoader();
                // Load an image file into a custom material
                var material = new THREE.MeshLambertMaterial({
                    map: loader.load('https://i.imgur.com/2u64LR5.png')
                });
                // create a plane geometry for the image with a width of 10
                // and a height that preserves the image's aspect ratio
                var geometry = new THREE.PlaneGeometry(5, 5);
                // combine our image geometry and material into a mesh
                var mesh = new THREE.Mesh(geometry, material);
                // set the position of the image mesh in the x,y,z dimensions
                mesh.position.set(0, 0, 0)
                // add the image to the scene
                scene.add(mesh);
            }

            function drawPokeball() {
                var loader = new THREE.GLTFLoader();

                loader.load(MODEL_PATH, function (gltf) {
                    pokeball = gltf.scene;
                    // pokeball.scale.set(.5, .5, .5);
                    //  pokeball.scale.set(.05, .05, .05);
                    // selectedModel.position.y = 45;
                    scene.add(pokeball);
                    animate();

                }, undefined, function (error) {
                    console.error(error);
                });
            }

        }

        function start(f_x, f_y, f_z) {
            throwb = true
            sphereBody.mass /= 2
            sphereBody.position.set(0, -2, 0)
            sphereBody.velocity.set(10, 15, -10)
            sphereBody.angularVelocity.set(0, 0, 0)
            // sphereBody.force.set(1000, 1500, -1000)
            // sphereBody.torque.set(-100, 0, 100)

            // sphereBody.mass = 5

            // sphereBody.applyForce(
            //     new CANNON.Vec3(0, 5, -5),
            //     new CANNON.Vec3(0, 0, 0)
            // )
        }

        function updatePhysics() {
            world.step(timeStep);
            if (isclick)
                setBallPos()
            pokeball.position.copy(sphereBody.position);
            pokeball.quaternion.copy(sphereBody.quaternion);
        }

        function animate() {
            updatePhysics();
            get_mouse_move = true
            // sphereBody.position.set(0, -2, 0)
            // if (throwb)
            // sphereBody.angularVelocity.set(0, 0, 10)

            // console.log(isclick, sphereBody.mass, sphereBody.velocity)
            // sphereBody.velocity.z = 0
            // console.log(sphereBody.velocity)
            // console.log(sphereBody.position.x, sphereBody.position.y, sphereBody.position.z);

            // setTimeout(animate, 100)
            requestAnimationFrame(animate);
            renderer.render(scene, camera);

            // if (sphereBody.velocity.y > 0) console.log('positive')
            // else {
            //     if (throwb) {
            //         // throwb = false
            //         sphereBody.velocity.y -= 0.5
            //     }
            //     console.log('negative')
            // }
        }

        function onCursorDown(x, y) {
            isclick = true
            sphereBody.velocity.set(0, 0, 0)
            sphereBody.angularVelocity.set(0, 0, 0)
            sphereBody.position.z = 0
            // console.log(sphereBody)
            // sphereBody.mass = 0
            mouse_cur.x = x;
            mouse_cur.y = y;
        }

        function onCursorMove(x, y) {
            let over_window = false
            // console.log(e.clientX, e.clientY)
            if (!isclick || !get_mouse_move) return
            get_mouse_move = false
            // v.x += e.clientX
            // v.y += e.clientY
            // v.x /= 2
            // v.y /= 2

            if (x <= 0 || x >= window.innerWidth) {
                over_window = true
                console.log('over x')
            }
            else {
                mouse_last.x = mouse_cur.x
                mouse_cur.x = x;
            }
            if (y <= 0 || y >= window.innerHeight) {
                over_window = true
                console.log('over y')
            }
            else {
                mouse_last.y = mouse_cur.y
                mouse_cur.y = y;
            }
            if (over_window) {
                canvas2.trigger('mouseup');
                canvas2.trigger('touchend');
            }
        }

        function onCursorUp() {
            if (!isclick) return
            throwb = true
            isclick = false
            var movement = chgPosToCannon(
                mouse_cur.x - mouse_last.x + window.innerWidth / 2,
                mouse_cur.y - mouse_last.y + window.innerHeight / 2
            )
            throwBall(movement)
        }


        function setBallPos() {
            var raycaster = new THREE.Raycaster();
            var vector = new THREE.Vector3(
                (mouse_cur.x / window.innerWidth) * 2 - 1,
                - (mouse_cur.y / window.innerHeight) * 2 + 1,
                0.5
            );
            vector.unproject(camera);
            var dir = vector.sub(camera.position).normalize();
            var distance = - camera.position.z / dir.z;
            var pos = camera.position.clone().add(dir.multiplyScalar(distance));
            sphereBody.position.x = pos.x
            sphereBody.position.y = pos.y
        }

        function chgPosToCannon(x, y) {
            var raycaster = new THREE.Raycaster();
            var vector = new THREE.Vector3(
                (x / window.innerWidth) * 2 - 1,
                - (y / window.innerHeight) * 2 + 1,
                0.5
            );
            vector.unproject(camera);
            var dir = vector.sub(camera.position).normalize();
            var distance = - camera.position.z / dir.z;
            var pos = camera.position.clone().add(dir.multiplyScalar(distance));
            return pos
        }

        function throwBall(movement) {
            const v = {
                x: ~~(movement.x / timeStep / 10),
                y: ~~(movement.y / timeStep / 10)
            }
            const offset = 5
            v.x += v.x > 0 ? offset : -offset
            v.y += v.y > 0 ? offset : -offset
            if (v.x == -offset) v.x = 0
            if (v.y == -offset) v.y = 0

            // console.log(
            //     (x - mouse_cur.x) + '\n' +
            //     (e.clientY - mouse_cur.y) + '\n' +
            //     Math.sqrt((x - mouse_cur.x) ** 2 + (e.clientY - mouse_cur.y) ** 2) + '\n' +
            //     v.x + '\n' +
            //     v.y + '\n'
            // )

            // console.log(v.x + '\n' + v.y)

            sphereBody.velocity.set(
                v.x,
                v.y,
                // sphereBody.position.y * 10, 
                -10
            )
            // sphereBody.velocity.set(
            //     cur_pos.x / timeStep,
            //     cur_pos.y / timeStep / 2,
            //     // sphereBody.position.y * 10, 
            //     -10
            // )
            // sphereBody.angularVelocity.set(0, 0, 5)
            // console.log(dx, dy, dz)
        }

    </script>
</body>

</html>
<html>

<head>
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        canvas {
            position: absolute;
            top: 0;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/three.js/110/three.js'></script>
    <script src="js/lib/GLTFLoader.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
    <canvas id='cns'></canvas>
    <script>

        const canvas = $('#cns')[0]
        const ctx = canvas.getContext('2d')

        canvas.width = window.innerWidth
        canvas.height = window.innerHeight

        const img = new Image()
        img.onload = function () {
            ctx.drawImage(img, window.innerWidth / 2 - img.width / 2, 0)
        }
        img.src = 'https://i.imgur.com/2u64LR5.png'

        const ball = {
            pos: {
                x: window.innerWidth / 2,
                y: window.innerHeight * 0.85
            },
            size: { w: 75, h: 75 },
            velocity: { x: 0, y: 10 },
            img: new Image(),
            draw: function (ctx) {
                ctx.drawImage(
                    this.img,
                    this.pos.x - this.size.w / 2,
                    this.pos.y - this.size.h / 2,
                    this.size.w,
                    this.size.h
                )
            }
        }
        const gravity = 9.8

        ball.img.onload = function () {
            ball.draw(ctx)
        }
        ball.img.src = 'https://i.imgur.com/yZCHxYY.png'



        onmousemove = function (event) {
            return
            ball.pos.x = event.clientX
            ball.pos.y = event.clientY
            draw()
        }


        function throwBall() {
            ball.pos.x += ball.velocity.x
            ball.pos.y += ball.velocity.y
            ball.velocity.y
        }

        function draw() {
            ctx.clearRect(0, 0, window.innerWidth, window.innerHeight)
            ctx.drawImage(img, window.innerWidth / 2 - img.width / 2, 0)
            ball.draw(ctx)
        }


    </script>

    <script>
        var world, sphereBody, timeStep, s_mass = 1;
        var scene, camera, renderer, pokeball;
        var isclick = false, get_pos_req = false;
        var mouse = new THREE.Vector2();

        var throwb = false;

        initCannon()
        initThree()

        window.addEventListener("mousedown", onMouseDown, false);
        window.addEventListener("mousemove", onMouseMove, false);
        window.addEventListener("mouseup", onMouseUp, false);



        function initCannon() {
            world = new CANNON.World();
            world.quatNormalizeSkip = 0;
            world.quatNormalizeFast = false;

            world.gravity.set(0, -10, 0);
            world.broadphase = new CANNON.NaiveBroadphase();


            // Create a sphere
            var radius = 1; // m
            sphereBody = new CANNON.Body({
                mass: s_mass, // kg
                position: new CANNON.Vec3(0, -2, 0), // m
                shape: new CANNON.Sphere(radius)
            });
            world.addBody(sphereBody);


            var groundShape = new CANNON.Plane();
            var groundBody = new CANNON.Body({ mass: 0 });
            groundBody.addShape(groundShape);
            groundBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), -Math.PI / 2);
            groundBody.position.y = -3
            world.addBody(groundBody);


            timeStep = 1.0 / 60.0; // seconds
        }


        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            camera.position.z = 5;
            var hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444);
            hemiLight.position.set(0, 0, 0);
            scene.add(hemiLight);

            // drawPokemon()
            drawPokeball()

            function drawPokemon() {
                var loader = new THREE.TextureLoader();
                // Load an image file into a custom material
                var material = new THREE.MeshLambertMaterial({
                    map: loader.load('https://i.imgur.com/2u64LR5.png')
                });
                // create a plane geometry for the image with a width of 10
                // and a height that preserves the image's aspect ratio
                var geometry = new THREE.PlaneGeometry(5, 5);
                // combine our image geometry and material into a mesh
                var mesh = new THREE.Mesh(geometry, material);
                // set the position of the image mesh in the x,y,z dimensions
                mesh.position.set(0, 0, 0)
                // add the image to the scene
                scene.add(mesh);
            }

            function drawPokeball() {
                var loader = new THREE.GLTFLoader();

                loader.load('3d/pokeball.glb', function (gltf) {
                    pokeball = gltf.scene;
                    // pokeball.scale.set(.5, .5, .5);
                    //  pokeball.scale.set(.05, .05, .05);
                    // selectedModel.position.y = 45;
                    scene.add(pokeball);
                    animate();

                }, undefined, function (error) {
                    console.error(error);
                });
            }

        }




        function start(f_x, f_y, f_z) {
            throwb = true
            sphereBody.mass /= 2
            sphereBody.position.set(0, -2, 0)
            sphereBody.velocity.set(10, 15, -10)
            sphereBody.angularVelocity.set(0, 0, 0)
            // sphereBody.force.set(1000, 1500, -1000)
            // sphereBody.torque.set(-100, 0, 100)

            // sphereBody.mass = 5

            // sphereBody.applyForce(
            //     new CANNON.Vec3(0, 5, -5),
            //     new CANNON.Vec3(0, 0, 0)
            // )
        }


        function updatePhysics() {
            world.step(timeStep);
            if (isclick)
                setBallPos()
            pokeball.position.copy(sphereBody.position);
            pokeball.quaternion.copy(sphereBody.quaternion);
        }

        function animate() {

            updatePhysics();
            // sphereBody.position.set(0, -2, 0)
            // if (throwb)
            // sphereBody.angularVelocity.set(0, 0, 10)

            get_pos_req = true
            // console.log(isclick, sphereBody.mass, sphereBody.velocity)
            // sphereBody.velocity.z = 0
            // console.log(sphereBody.velocity)
            // console.log(sphereBody.position.x, sphereBody.position.y, sphereBody.position.z);

            // setTimeout(animate, 100)
            requestAnimationFrame(animate);
            renderer.render(scene, camera);

            if (sphereBody.velocity.y > 0) console.log('positive')
            else {
                if (throwb) {
                    // throwb = false
                    sphereBody.velocity.y -= 0.5
                }
                console.log('negative')
            }
        }


        function onMouseDown(e) {
            isclick = true
            sphereBody.velocity.set(0, 0, 0)
            sphereBody.angularVelocity.set(0, 0, 0)
            sphereBody.position.z = 0
            // console.log(sphereBody)
            // sphereBody.mass = 0
            mouse.x = e.clientX;
            mouse.y = e.clientY;
        }

        function onMouseMove(e) {
            // console.log(e.clientX, e.clientY)
            if (!isclick || !get_pos_req) return
            get_pos_req = false
            mouse.x = e.clientX;
            mouse.y = e.clientY;
        }

        function onMouseUp(e) {
            throwb = true
            isclick = false
            // sphereBody.mass = s_mass
            var cur_x = e.clientX;
            var cur_y = e.clientY;
            var dx = (cur_x - mouse.x) / timeStep
            var dy = (cur_y - mouse.y) / timeStep
            var dz = -1 * Math.sqrt(dx ** 2 + dy ** 2)


            // sphereBody.velocity.set(dx, dy, dz)
            sphereBody.velocity.set(-5, 10, -5)
            // sphereBody.angularVelocity.set(0, 0, 5)
            console.log(dx, dy, dz)
        }

        function setBallPos() {
            var raycaster = new THREE.Raycaster();
            var vector = new THREE.Vector3(
                (mouse.x / window.innerWidth) * 2 - 1,
                - (mouse.y / window.innerHeight) * 2 + 1,
                0.5
            );
            vector.unproject(camera);
            var dir = vector.sub(camera.position).normalize();
            var distance = - camera.position.z / dir.z;
            var pos = camera.position.clone().add(dir.multiplyScalar(distance));
            sphereBody.position.x = pos.x
            sphereBody.position.y = pos.y

        }

    </script>
</body>

</html>
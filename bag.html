<html>

<head>
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        canvas {
            position: absolute;
            top: 0;
        }

        .float {
            position: absolute;
            top: 0;
        }
    </style>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
        integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <!-- <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
        crossorigin="anonymous"></script>
</head>

<body>
    <!-- <div class='row'>
        <div class='col'>
            <span class='position-absolute'>CP</span>
            <img src='http://192.168.0.102:8080/img/pokemon/003.png' width='100'>
        </div>
    </div> -->
    <div id='bag' class='container'></div>
    <div class='pokemon_detail container text-center'>
        <p id='bag_cp' class='pokemon_number'>cp2500</p>
        <image id='bag_img' src='static/img/pokemon/006.png' width='250'></image>
        <p id='bag_name' class='pokemon_name'>噴火龍</p>
        <br>
        <div class='pokemon_HB row'>
            <div class='col'>
                <div id='bag_height' class='pokemon_height_value'>1.7 m</div>
                <div class='pokemon_height_title'>身高</div>
            </div>
            <div id='bag_type' class='col'>
                <!-- <div class='col-2'>屬性</div> -->
                <span class='col'>火</span>
                <span class='col'>飛行</span>
            </div>
            <div class='col'>
                <div id='bag_weight' class='pokemon_weight_value'>90.5 kg</div>
                <div class='pokemon_height_title'>體重</div>
            </div>
        </div>
    </div>
    <script>
        const TYPE = [
            '一般', '火', '水', '電', '草', '冰', '格鬥', '毒', '地面'
            , '飛行', '超能力', '蟲', '岩石', '幽靈', '龍', '惡', '鋼', '妖精'
        ]

        const PATH = {
            pokedex: '/static/data/pokemon.json',
            poke_img: "static/img/pokemon/"
        }
        const ELEM_ID = {
            bag: '#bag'
        }
        const SIZE = {
            bag_img: 100
        }
        const BAG_ROW_CONTAIN = 4
        const MAX_POK_LEN = 50//386
        const random_pokemon_num = 22
        const POKEMONS = []
        const POK_IMG = []
        let cnt = 0;

        class BAG {
            constructor() {
                this.UI = $(ELEM_ID.bag)
                this.poke_list = {
                    cur_sort: null,
                    byNumber: null,
                    byCp: null,
                    byTime: null
                }
                // TODO: get data
                $.ajax({
                    url: "load_pokemon"
                }).done(function (data) {
                    // console.log(data)
                    this.poke_list.byTime = data
                    this.poke_list.cur_sort = this.poke_list.byTime
                    // sort by cp
                    this.poke_list.byCp = this.poke_list.byTime.slice().sort((a, b) => {
                        if (a.cp < b.cp) {
                            return 1;
                        }
                        if (a.cp > b.cp) {
                            return -1;
                        }
                        return 0;
                    });
                    // sort by number
                    this.poke_list.byNumber = this.poke_list.byCp.slice().sort((a, b) => {
                        if (a.number < b.number) {
                            return -1;
                        }
                        if (a.number > b.number) {
                            return 1;
                        }
                        return 0;
                    });
                    this.show()
                }.bind(this));
            }

            catching(/*pokemon*/) {
                const pokemon = {
                    time: 0,
                    number: Math.floor(Math.random() * MAX_POK_LEN),
                    height: Math.floor(Math.random() * 15),
                    weight: Math.floor(Math.random() * 100),
                    cp: Math.floor(Math.random() * 3000),
                }

                if (this.poke_list.byTime.slice(-1)[0] != undefined)
                    pokemon.time = this.poke_list.byTime.slice(-1)[0].time + 1

                $.ajax({
                    url: "add_pokemon",
                    data: pokemon,
                }).done(function (data) {
                    console.log(data)
                });


                // push in "by time" 
                console.log(pokemon.cp)
                this.poke_list.byTime.push(pokemon);
                // push in "by number" & "by cp"
                if (this.poke_list.byTime.length == 1) {
                    this.poke_list.byNumber.push(pokemon)
                    this.poke_list.byCp.push(pokemon)
                }
                else {
                    pushByNumber(this.poke_list.byNumber, pokemon)
                    pushByCp(this.poke_list.byCp, pokemon)
                }


                this.show()

                function pushByNumber(arr, pokemon) {
                    let flag = false
                    for (let i in arr) {
                        if (
                            pokemon.number < arr[i].number ||
                            (pokemon.number == arr[i].number &&
                                pokemon.cp >= arr[i].cp)
                        ) {
                            flag = true
                            arr.splice(i, 0, pokemon)
                            break
                        }
                    }
                    if (!flag) arr.push(pokemon)
                }

                function pushByCp(arr, pokemon) {
                    let flag = false
                    for (let i in arr) {
                        if (pokemon.cp > arr[i].cp) {
                            flag = true
                            arr.splice(i, 0, pokemon)
                            break
                        }
                    }
                    if (!flag) arr.push(pokemon)
                }
            }

            remove(index/*pokemon*/) {
                let arr = this.poke_list.byTime
                const pokemon = arr[index]
                arr.splice(arr.indexOf(pokemon), 1)
                arr = this.poke_list.byCp
                arr.splice(arr.indexOf(pokemon), 1)
                arr = this.poke_list.byNumber
                arr.splice(arr.indexOf(pokemon), 1)
                this.show()

                $.ajax({
                    url: "remove_pokemon",
                    data: {
                        time: pokemon.time
                    }
                }).done(function (data) {
                    console.log(data)
                }.bind(this));
            }

            sort(cmd) {
                switch (cmd) {
                    case 0:
                        this.poke_list.cur_sort = this.poke_list.byNumber
                        console.log('sort by number')
                        break;
                    case 1:
                        this.poke_list.cur_sort = this.poke_list.byCp
                        console.log('sort by cp')
                        break;
                    case 2:
                        this.poke_list.cur_sort = this.poke_list.byTime
                        console.log('sort by time')
                        break;
                }
                this.show()
            }

            show() {
                let i = 0, len = this.poke_list.cur_sort.length - i;
                this.UI.html('')
                while (len > 0) {
                    const row = document.createElement('div')
                    row.setAttribute('class', 'row')
                    if (len > BAG_ROW_CONTAIN) len = BAG_ROW_CONTAIN
                    for (let j = i; j < i + len; ++j) {
                        let poke_number = this.poke_list.cur_sort[j].number,
                            col = document.createElement('div'),
                            span = document.createElement('span'),
                            img = POK_IMG[poke_number].cloneNode(false);

                        col.setAttribute('class', 'col-3')
                        span.setAttribute('class', 'position-absolute')
                        span.innerHTML = this.poke_list.cur_sort[j].cp
                        img.width = SIZE.bag_img
                        img.onclick = function () {
                            this.showDetail(this.poke_list.cur_sort[j])
                        }.bind(this)
                        col.appendChild(span)
                        col.appendChild(img)
                        row.appendChild(col)
                    }
                    this.UI.append(row)
                    i += BAG_ROW_CONTAIN
                    len = this.poke_list.cur_sort.length - i
                }
            }

            showDetail(pokemon) {
                const bag_ID = {
                    cp: '#bag_cp',
                    img: '#bag_img',
                    name: '#bag_name',
                    type: '#bag_type',
                    height: '#bag_height',
                    weight: '#bag_weight',
                }
                const elem_type = $(bag_ID.type)
                $(bag_ID.cp).html('cp' + pokemon.cp)
                $(bag_ID.img).attr('src', POK_IMG[pokemon.number].cloneNode(false).src);
                $(bag_ID.name).html(POKEMONS[pokemon.number].name)
                $(bag_ID.height).html(pokemon.height)
                $(bag_ID.weight).html(pokemon.weight)
                return
                // type
                elem_type.empty()
                pokemon.types.forEach(i => {
                    let span = document.createElement('span')
                    span.innerHTML = TYPE[i]
                    elem_type.append(span)
                })
            }
        }

        // load pokedex data
        $.ajax({
            url: PATH.pokedex
        }).done(function (data) {
            data.forEach(e => {
                POKEMONS.push(e)
            });
        });

        // load image
        for (let i = 0; i < MAX_POK_LEN; ++i) {
            let fn = i + 1
            if (fn < 10) fn = '00' + fn
            else if (fn < 100) fn = '0' + fn
            POK_IMG[i] = document.createElement("img")
            POK_IMG[i].width = 50
            POK_IMG[i].setAttribute('draggable', false);
            // document.body.appendChild(POK_IMG[i])
            POK_IMG[i].onload = function () {
                POK_IMG[i].onclick = function () {
                    // setDexDetail(i + 1)
                }
                ++cnt
                if (cnt >= MAX_POK_LEN) {
                    console.log('load over')
                    console.log('create bag')
                    bag.show();
                }

            }
            POK_IMG[i].src = PATH.poke_img + fn + ".png"
        }


        const bag = new BAG();
        bag.poke_list.cur_sort = bag.poke_list.byTime
    </script>
</body>

</html>